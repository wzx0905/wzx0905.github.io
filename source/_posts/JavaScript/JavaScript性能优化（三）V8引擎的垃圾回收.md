---
title: JavaScript性能优化（三）V8引擎的垃圾回收
date: 2021/4/25
categories:
 - [前端,JavaScript]
---

# 认识`V8`

- `V8`是一款主流的`JavaScript`执行引擎
- `V8`采用即时编译
- `V8`内存设置上限

# `V8`引擎的工作流程

![](https://pic.imgdb.cn/item/60e6a8345132923bf8796b27.png)

- `Scanner`是`V8`提供的扫描器

![](https://pic.imgdb.cn/item/60e6a9405132923bf880fac4.png)

- `Parser`是`V8`提供的解析器
  - `PreParser`预解析
    - 跳过未被使用的代码
    - 不生成`AST`，创建无变量引用和声明的`scopes`
    - 依据规范抛出特定错误
    - 解析速度更快
  - `Parser`全量解析
    - 解析被使用的代码
    - 生成`AST`
    - 构建具体的`scopes`信息，变量引用、声明等
    - 抛出所有语法错误

```js
// 声明时未调用，因此会被认为时不被执行的代码，进行预解析
function foo() {
  console.log('foo')
}
// 声明时未调用，因此会被认为时不被执行的代码，进行预解析
function fn() {}
// 函数立即执行，只进行一次全量解析
(function bar() {
})()
// 执行 foo，那么需要重新对 foo 函数进行全量解析，此时 foo 函数被解析了两次
foo()
```

- `Ignition`是`V8`提供的解释器
- `TurboFan`是`V8`提供的编译器

# `V8`垃圾回收策略

- `V8`基于分代回收的思想实现垃圾回收
- `V8`内存分为新生代、老年代
- `V8`针对不同对象采用不同算法

# `V8`中常用的`GC`算法

- 分代回收
- 空间复制
- 标记清除
- 标记整理
- 标记增量

# `V8`内存分配

- `V8`内存空间一份为二
- 小空间用于存储新生代对象（64位操作系统`32M`，32位操作系统`16M`），新生代指的是存活时间较短的对象
- 大空间用于存储老年代对象（64位操作系统`1.4G`，32位操作系统`700M`），老年代指的是存活时间较长的对象

# 新生代对象回收

- 回收过程采用复制算法+标记整理
- 新生代内存区分为两个等大小的空间
- 使用空间为`From`，空闲空间为`To`
- 活动对象存储于`From`空间
- 标记整理后将活动对象拷贝至`To`
- `From`与`To`交换空间完成释放

> 细节说明
>
> - 拷贝过程中可能出现晋升
> - 晋升就是将新生代对象移动到老年代
> - 一轮`GC`之后还存活的新生代需要晋升
> - `To`空间的使用率超过25%

# 老年代对象回收

- 主要采用标记清除、标记整理、增量标记算法
- 首先使用标记清除完成垃圾空间的回收
- 采用标记整理进行空间优化
- 采用增量标记进行效率优化

![](https://pic.imgdb.cn/item/60e695d15132923bf8e89ea0.png)

# 新生代和老年代细节对比

- 新生代区域垃圾回收使用空间换时间
- 老年代区域垃圾回收不适合复制算法
